# README:Monkey-X-NIC

è¿™æ˜¯ç”µå­ç§‘æŠ€å¤§å­¦æœ¬ç§‘æ¯•è®¾:Monkey-X-NICï¼ˆMinkun-Xue-NICï¼‰ã€‚å¯¹Corundumçš„è°ƒåº¦å™¨è¿›è¡Œäº†æ”¹åŠ¨ï¼Œå®ç°äº†SIGCOMM23å’ŒSIGCOMM24çš„å¯ç¼–ç¨‹è°ƒåº¦å™¨è®¾è®¡BMW-Treeå’ŒvPIFOã€‚è¿™ä¸¤é¡¹å·¥ä½œæ˜¯å‘è¡¨äºSIGCOMM16çš„å¯ç¼–ç¨‹è°ƒåº¦æ¨¡å‹PIFOçš„æ‹“å±•ã€‚PIFOæ­¤å‰å·²ç»å—åˆ°å¹¿æ³›çš„å…³æ³¨å’Œç ”ç©¶ã€‚æœ¬é¡¹ç›®åŸºäºCorundumå¼€æºç½‘å¡ï¼Œå®ç°äº†é¦–ä¸ªæ”¯æŒå¯ç¼–ç¨‹è°ƒåº¦çš„å¼€æºç½‘å¡ã€‚

## å†™ä½œå‰é¢

å¦‚ä½•ä½¿æœ¬è®¾è®¡ç”Ÿæ•ˆï¼Ÿ

```verilog
#1ç”Ÿæˆbitstream
cd /path/to/Monkey-X-NIC/fpga/mqnic/Alveo/fpga_100g/fpga_AU200
make 
#2ä½¿ç”¨Vivado-Hardware-Managerçƒ§å½•è‡³Xilinx-Alveo-U200
#æ­¤å¤„ç•¥
#3çƒ­é‡å¯æ¿å¡
cd /path/to/Monkey-X-NIC/scripts/pcie
sudo ./pcie_reset.sh 41:00.0  #é‡ç½®PCIeæ’æ§½
#4è£…è½½é©±åŠ¨
sudo rmmod mqnic  #å¸è½½é©±åŠ¨
sudo ./pcie_rescan.sh #æ‰«æPCIeè®¾å¤‡
cd /path/to/Monkey-X-NIC/modules/mqnic
sudo insmod mqnic.ko  #é‡æ–°è£…è½½é©±åŠ¨
#5è¿é€šæ€§ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªä¸»æœºpingï¼‰
ip a #æŸ¥çœ‹ç½‘å£åï¼Œä¸ºenp65s0np0
sudo ip link set dev enp65s0np0 up
sudo ip addr add 172.0.0.2/24 enp65s0np0
sudo ip link set mtu 9000 dev enp65s0np0
ping 10.0.0.2 #èƒ½pingé€š
#6å¯ç¼–ç¨‹æ€§æµ‹è¯•
cd /path/to/Monkey-X-NIC/scripts/
python3 testx
python3 testy
python3 testz
```

## 0.æ•´ä½“æ¡†å›¾

æ•´ä½“è®¾è®¡ï¼š

![image/image-20241201121237333.png](image-20241201121237333.png)

æ—¶é’Ÿæ ‘é€»è¾‘æ•´ç†ï¼š

![image/image.png](image.png)

## 1.ç§»æ¤å‡†å¤‡

æ¢³ç†æ•°æ®åŒ…æµç¨‹ï¼š

è§6-8èŠ‚

## 2.å…³é”®ç‚¹

1.HOSTå‘NICå‘èµ·**æ§åˆ¶äº¤äº’**çš„æ–¹å¼ä¸ºMMIOï¼›NICå‘HOSTå‘èµ·**æ§åˆ¶äº¤äº’**çš„æ–¹å¼ä¸ºè§¦å‘ä¸­æ–­ã€‚

2.**åªéœ€è¦å…³æ³¨å‘é€æ•°æ®è¿‡ç¨‹**ï¼Œæ¥æ”¶æ•°æ®è¿‡ç¨‹ä¸æ¶‰åŠè°ƒåº¦å™¨ã€‚

3.HOSTé©±åŠ¨é¢„å…ˆæ„é€ äº†ä¸¤ä¸ªç¼“å­˜åŒºï¼Œä¸€ä¸ªforæ‰€æœ‰æè¿°ç¬¦é˜Ÿåˆ—ï¼Œå¦ä¸€foræ‰€æœ‰çš„skbã€‚

4.æè¿°ç¬¦å’ŒçœŸå®çš„åŒ…**éƒ½åœ¨HOSTå†…å­˜**ä¸­ï¼ŒNICéœ€è¦å‘èµ·**ä¸¤æ¬¡DMAè¯»**æ‰èƒ½è·å–çœŸå®çš„åŒ…ï¼šä¸€æ¬¡foræè¿°ç¬¦ï¼Œæ‹¿åˆ°æè¿°ç¬¦(å­˜æœ‰çœŸåŒ…åœ°å€åŠå…¶ä»–ä¿¡æ¯)åï¼Œç¬¬äºŒæ¬¡DMAè¯»åˆ°çœŸå®åŒ…ã€‚

5.NICåœ¨å‘èµ·**ä¸¤æ¬¡DMAè¯»æ“ä½œä¹‹å‰**å°±å†³å®šå¥½äº†è¦è°ƒåº¦å“ªä¸ªé˜Ÿåˆ—ã€‚

6.HOSTå’ŒNICåŒæ–¹ç»´æŠ¤å‘é€æ•°æ®çš„æ–¹å¼æ˜¯é€šè¿‡**é«˜åº¦åŒæ­¥çš„é˜Ÿåˆ—ç”Ÿäº§è€…æŒ‡é’ˆå’Œæ¶ˆè´¹è€…æŒ‡é’ˆ**ã€‚

![image/image.png](image%201.png)

7.è°ƒåº¦å™¨æ¨¡å—èƒ½çœ‹åˆ°çš„é˜Ÿåˆ—ä¿¡æ¯**åªæœ‰é—¨é“ƒäº‹ä»¶**ï¼Œ**ä»¥åŠè°ƒåº¦åçš„åé¦ˆ**ï¼ˆæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œé˜Ÿåˆ—æ˜¯å¦å·²ç»ä¸ºç©ºï¼‰ã€‚ï¼ˆå³ï¼Œé€šçŸ¥å“ªä¸ªé˜Ÿåˆ—æœ‰æ›´æ–°ï¼‰ï¼Œå¹¶æ²¡æœ‰ä»»ä½•ä¼˜å…ˆçº§ä¿¡æ¯ä¾›ç»™è°ƒåº¦å™¨ï¼Œæ‰€ä»¥å¿…é¡»å¢åŠ ä¼˜å…ˆçº§å¼•è„šã€‚

8.**è°ƒåº¦å™¨åªå’ŒTX-QueueManagerå’ŒTX-Engineè¿›è¡Œæ•°æ®äº¤äº’**ã€‚ï¼ˆè¿˜æœ‰é©±åŠ¨çš„é«˜çº§æ§åˆ¶ä¿¡æ¯å»ä½¿èƒ½æŸé˜Ÿåˆ—æ˜¯å¦åº”è¯¥è¢«ç¦æ­¢è°ƒåº¦ï¼‰

9.è°ƒåº¦å™¨å†…éƒ¨å’ŒQueueMangerå†…éƒ¨é€šè¿‡URAMå­˜å‚¨æµ·é‡é˜Ÿåˆ—çš„æ§åˆ¶ä¿¡æ¯ï¼Œ**è¯»å†™æœ‰å»¶è¿Ÿ**ï¼Œå› æ­¤å†…éƒ¨é€šè¿‡åˆ’åˆ†**4çº§æµæ°´çº¿**çš„æ–¹å¼ç¼“è§£æ­¤é—®é¢˜ã€‚

10.**æ¯ä¸ªé—¨é“ƒäº‹ä»¶å¯¹åº”ä¸€ä¸ªåŒ…**ï¼Œåœ¨è°ƒåº¦å™¨ä¸­**åªä½¿ç”¨äº†ä¸€ä¸ªdoorbell_fifo**ï¼Œç”¨æ¥**å­˜å‚¨æ‰€æœ‰çš„é—¨é“ƒäº‹ä»¶**ã€‚åŸå§‹çŠ¶æ€ä¸ºper-packetè°ƒåº¦ã€‚

11.æ‰©å±•æ€§ï¼šæ¯ä¸ªæ¥å£åŸåˆ™ä¸Šåº”æ‰©å±•ä¸ºå¯ä¾‹åŒ–å¤šä¸ªè°ƒåº¦å™¨å¹¶å‘æ‰§è¡Œè°ƒåº¦æ“ä½œï¼›åŸåˆ™ä¸Šé©±åŠ¨å¯ä»¥è®¾ç½®ä¸ºï¼š1 Packetâ‰ 1 Doorbellã€‚

12.è°ƒåº¦å™¨**å°è¯•åœ¨ç©ºé˜Ÿåˆ—ä¸Šå‘é€**æ˜¯ä¸€ç§ç›¸å¯¹è¾ƒä½æˆæœ¬çš„åœºæ™¯ï¼Œè€Œä¸æ˜¯å‡è®¾é˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šå¯¼è‡´æ•°æ®åŒ…æ— é™æœŸå¡ä½ã€‚å› æ­¤ç›´åˆ°åé¦ˆä¿¡æ¯çš„åˆ°æ¥ï¼Œå®ƒæ‰ä¼šå°†ç›¸åº”é˜Ÿåˆ—å‡ºé˜Ÿã€‚

13.[linuxå†…æ ¸åè®®æ ˆä¹‹ç½‘å¡å‘é€é˜Ÿåˆ—é€‰æ‹©_skb set queue mapping-CSDNåšå®¢](https://blog.csdn.net/wangquan1992/article/details/128619291)

## 3.TODO List

1.é©±åŠ¨ç«¯ï¼šåœ¨é©±åŠ¨é€šçŸ¥NICæœ‰æ–°æ•°æ®åŒ…æ—¶ï¼Œå‘èµ·MMIOæ“ä½œé€šçŸ¥NICç›¸åº”é˜Ÿåˆ—çš„ç”Ÿäº§è€…æŒ‡é’ˆæ›´æ–°ä¸ºæŒ‡å®šå€¼çš„åŒæ—¶ï¼Œåº”è¯¥åšä»¥ä¸‹ä¿®æ”¹ï¼š

> iowriteç»™NICç”Ÿäº§è€…æŒ‡é’ˆä¿¡æ¯çš„åŒæ—¶ï¼Œåº”è¯¥å°†æ­¤åŒ…çš„**ä¼˜å…ˆçº§**ä¹Ÿä¼ é€ç»™NICã€‚è¿™ä¸€æ–¹é¢æ¶‰åŠåˆ°å¦‚ä½•è®¡ç®—ä¼˜å…ˆçº§ï¼Œå¦ä¸€æ–¹é¢æ¶‰åŠåˆ°å¦‚ä½•å‘é€æ­¤ä¼˜å…ˆçº§ã€‚
> 

2.NICç«¯Queue-Managerï¼šåœ¨MMIOäº‹ä»¶æ¥ä¸´æ—¶ï¼Œåšå¥½æ¥æ”¶é˜Ÿåˆ—æ›´æ–°åŠå…¶åŒ…ä¼˜å…ˆçº§çš„å‡†å¤‡,å¹¶ä¸”ä¼ é€’ç»™è°ƒåº¦å™¨ï¼š

> MMIOäº‹ä»¶äº¤ç”±NICç«¯ç›¸åº”çš„æ§åˆ¶å¯„å­˜å™¨åˆ¤æ–­ï¼Œæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚è¿™æ¶‰åŠåˆ°æ„é€ å’Œè§£ææ–°çš„æ§åˆ¶å‘½ä»¤ã€‚ï¼ˆä¸ºä»€ä¹ˆä¸èƒ½è¦†ç›–åŸæœ¬çš„æ—§å‘½ä»¤ï¼Ÿå› ä¸ºé©±åŠ¨å»ºç«‹å­˜å‚¨æ˜ å°„çš„è¿‡ç¨‹è¿˜ä½¿ç”¨äº†æ­¤æ—§å‘½ä»¤ï¼‰
> 

3.NICç«¯Queue-Managerï¼šé˜Ÿåˆ—æ§åˆ¶è¡¨çš„è¯»å†™æœ‰å»¶è¿Ÿï¼Œæ•´ä½“æ¶æ„æ˜¯å››çº§æµæ°´çº¿ï¼Œä¼˜å…ˆçº§ä¿¡æ¯ä¹Ÿåº”è¯¥é‡‡ç”¨æµæ°´çº¿æ–¹å¼æ¥æ”¶ï¼Œè¿™æ¶‰åŠä»¥ä¸‹ä¿®æ”¹ï¼š

> æ­£ç¡®åœ¨æ—¶åºé€»è¾‘å’Œç»„åˆé€»è¾‘ä¸­åŒæ­¥å’Œæ¨è¿›queue_priority_nextå’Œqueue_priority_regï¼›æ­£ç¡®åˆ©ç”¨å…¶ä»–ä¿¡å·çš„æµæ°´çº¿æ¨è¿›çŠ¶æ€ï¼Œé¿å…äº§ç”Ÿoutputçš„priorityå’Œqueue_indexéåŒä¸€ç»„çš„é—®é¢˜ã€‚
> 

4.NICç«¯TX-Schedulerï¼šåœ¨Queue_Managerçš„outputåˆ°æ¥æ—¶ï¼Œåº”è¯¥æ­£ç¡®æ¥æ”¶ã€å­˜å‚¨ã€ä½¿ç”¨ï¼Œæ»¡è¶³vPIFOçš„å¤–ç½®éœ€æ±‚ã€‚

> è¿™æ¶‰åŠåˆ°doorbelläº‹ä»¶çš„rescheduleæ–¹å¼ï¼Œä¼˜å…ˆçº§è¦†ç›–é—®é¢˜ï¼Œä½•ç§æƒ…å†µdoorbellæ‰èƒ½å…¥bmw-treeï¼Œä½•ç§æƒ…å†µåº”è¯¥å‡ºbmw-treeï¼Œå®šä¹‰å¥½vPIFOçš„æ¥å£ã€‚
> 

5.NICç«¯TX-Schedulerï¼šåœ¨å¤„ç†å¥½å¤–ç½®æ¡ä»¶åï¼Œå®šä¹‰å¥½æ¥å£åã€‚åº”è¯¥åšä»¥ä¸‹å·¥ä½œï¼š

> éœ€è¦ä¿è¯åŒ…å‘é€çš„ä¼˜å…ˆçº§æ­£ç¡®æ€§ï¼Œä»¥åŠæ—¶åºæœ‰é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿å¾—ç”µè·¯åœ¨æ­£ç¡®çš„çŠ¶æ€ï¼Œæœ‰èƒ½åŠ›å¤„ç†BMW-Treeå»¶è¿Ÿå¤ªå¤§ã€‚
> 

## 4.æ›´æ”¹æ–¹æ¡ˆ

**1.é©±åŠ¨ç«¯ï¼š**

![image.png](image%202.png)

å¯¹â‘¥è¿›è¡Œæ›´æ”¹

```c
void mqnic_tx_write_prod_ptr(struct mqnic_ring *ring,u32 priority)
{
	iowrite32(MQNIC_QUEUE_CMD_SET_PROD_PTR | (ring->prod_ptr & MQNIC_QUEUE_PTR_MASK),
			ring->hw_addr + MQNIC_QUEUE_CTRL_STATUS_REG);
}
æ”¹ä¸ºï¼š
void mqnic_tx_write_prod_ptr(struct mqnic_ring *ring,u32 priority)
{
	iowrite32(**MQNIC_QUEUE_CMD_SET_PRIORITY** | (ring->prod_ptr & MQNIC_QUEUE_PTR_MASK) 
	    | **(priority & MQNIC_QUEUE_PRIORITY_MASK)**,
			ring->hw_addr + MQNIC_QUEUE_CTRL_STATUS_REG);
}
//å‘½ä»¤å­—MQNIC_QUEUE_CMD_SET_PROD_PTR ï¼š0x8080zzzz**æ”¹ä¸º
//MQNIC_QUEUE_CMD_SET_PRIORITY ï¼š**0xEzzzzzzz
//åŸæœ¬ä¸º0x8080zzzz,zzzzä¸ºæ›´æ–°åçš„ç”Ÿäº§è€…æŒ‡é’ˆ
//ç°åœ¨ä¸º0xEzzzzzzz,çº¢è‰²zzzä¸º12ä½çš„priorityï¼Œè“è‰²zzzä¸º16ä½çš„æŒ‡é’ˆã€‚
//why?
//ä»¥ä¸‹åŸå› ï¼šå¿…é¡»åœ¨æ­¤å‡½æ•°ä¸­å‘é€å‘½ä»¤ï¼Œè¿™æ ·**åªéœ€è¦å‘é€ä¸€æ¬¡å†…å­˜å±éšœ**ï¼Œå¦åˆ™ä¸ç„¶ã€‚
//å…¶æ¬¡è¿™ç§æ–¹å¼èƒ½ç»‘å®špacketå’Œpriorityçš„å…³ç³»ã€‚
//å‘½ä»¤å­—æ®µå¯ä»¥ä¿®æ”¹å—ï¼Ÿä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ
//ä¸ä¼šçš„ï¼Œæˆ‘æŸ¥çœ‹äº†æºç ï¼Œè¿™é‡Œè¿˜çœŸå°±æ²¡ä»€ä¹ˆç‰¹åˆ«çš„è¦æ±‚ã€‚
```

è¿™æ ·åšç»å¯¹æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæ²¡æœ‰å¼•å…¥å…¶ä»–çš„é€»è¾‘ç»“æ„ï¼Œæœ€å¤§ç¨‹åº¦åˆ©ç”¨äº†åŸå‡½æ•°ï¼Œä¸€å®šèƒ½å°†priorityå‘ç»™NICï¼Œä¸”NICä¸€å®šå¯ä»¥è¿›è¡ŒåŒºåˆ†ã€‚

> ä¸ºä»€ä¹ˆæ”¹å‘½ä»¤å­—ï¼Œå› ä¸ºæƒ³å¡ä¸‹ä¼˜å…ˆçº§å­—æ®µï¼ŒåŸå‘½ä»¤å­—å 16bitï¼Œprod_ptrå 16bitï¼›ç°åœ¨ä¸º4bitå‘½ä»¤å­—ï¼Œ12bitä¼˜å…ˆçº§ï¼Œ16bitçš„prod_ptrã€‚
> 

**2.NICç«¯Queue-Managerï¼š**

å¢åŠ ä¸€ä¸ªcaseåˆ†æ”¯å¦‚ä¸‹ï¼Œå¼•å…¥äº†**queue_priority_pipeline_reg**ï¼Œéœ€è¦æ­£ç¡®å¤„ç†æ­¤é€»è¾‘ï¼š

![image.png](image%203.png)

ä¸ºä»€ä¹ˆä¸è¦†ç›–åŸæœ¬çš„8080zzzzï¼Ÿå› ä¸ºè¿˜æœ‰ä¸éœ€è¦ä¼ é€’ä¼˜å…ˆçº§çš„è¿‡ç¨‹è°ƒç”¨æ­¤å‘½ä»¤ã€‚

**3.NICç«¯Queue-Managerï¼š**

![image.png](image%204.png)

**4.Queue_Managerçš„outputåˆ°è¾¾NICç«¯çš„scheduler**

åŸæœ¬çš„æ¶æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](image%205.png)

![è°ƒåº¦å™¨æ¶æ„å›¾.svg](%25E8%25B0%2583%25E5%25BA%25A6%25E5%2599%25A8%25E6%259E%25B6%25E6%259E%2584%25E5%259B%25BE.svg)

å¼•å…¥ä¼˜å…ˆçº§çš„æµç¨‹å¦‚ä¸‹ï¼š

![å›¾ç‰‡2.png](%25E5%259B%25BE%25E7%2589%25872.png)

**æ¢—æ¦‚ï¼š**æˆ‘åšçš„ä¿®æ”¹æ˜¯å°†queue_ramæ‹“å±•16bitï¼Œç”¨äºå­˜æ”¾é˜Ÿåˆ—çš„ä¼˜å…ˆçº§å­—æ®µã€‚å¥½å¤„åœ¨äºï¼šä¸ç”¨å†è‡ªå·±æ‰‹åŠ¨æ·»åŠ å¤æ‚çš„æµæ°´çº¿æ¨è¿›ï¼ˆæ¯•ç«Ÿæœ‰è¿‘åä¸ªäº‹ä»¶éœ€è¦è€ƒè™‘ï¼Œå¾ˆå®¹æ˜“å‡ºé”™ï¼‰ã€‚

åå¤„åœ¨äºæœ‰ä¼˜å…ˆçº§è¦†ç›–å¯¼è‡´çš„ä¼˜å…ˆçº§ä¸¢å¤±ç°è±¡ã€‚è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š

ç¬¬nä¸ªåŒ…åˆ°è¾¾å’Œç¬¬ä¸€ä¸ªåŒ…åˆ°è¾¾çš„åŒºåˆ«åœ¨äºï¼Œæœ‰**ä¼˜å…ˆçº§è¦†ç›–çš„é—®é¢˜ï¼Œ**åŸå› åœ¨äºqueue_ramæ¯ä¸ªé˜Ÿåˆ—çš„è¡¨é¡¹åªèƒ½å­˜å‚¨ä¸€ä¸ªä¼˜å…ˆçº§ã€‚å› æ­¤æ–°çš„doorbellçš„ä¼˜å…ˆçº§ä¼šè¦†ç›–æ‰è€çš„ã€‚æœ‰ä¼˜å…ˆçº§ä¸¢å¤±ç°è±¡ã€‚**æœ€æœ¬è´¨çš„åŸå› æ˜¯åŒ…å¹¶æ²¡æœ‰å’Œä¼˜å…ˆçº§è¿›è¡Œå¼ºç»‘å®šï¼Œå¼ºç»‘å®šä¼šå¢åŠ å¾ˆå¤šå¼€é”€ã€‚**

---

æˆ‘åšä¿®æ”¹åï¼Œè°ƒåº¦åŒ…è¿›å…¥ç¡¬ä»¶æ•°æ®ç»“æ„åªæœ‰ä¸‰ç§æƒ…æ™¯ï¼š

1.doorbelläº‹ä»¶æ¥ä¸´ï¼Œæ­¤æµè¿˜æ²¡æœ‰åœ¨æ•°æ®ç»“æ„ä¸­ã€‚å…¥é˜Ÿã€‚

2.è°ƒåº¦å™¨popå‡ºä¸€ä¸ªæµæ ‡ç­¾ï¼Œæ£€æŸ¥activeä½ï¼Œå¦‚æœä¸º1ï¼Œåˆ™è¡¨æ˜æ­¤æµæœ‰æ–°çš„doorbellï¼Œreschedã€‚é‡æ–°å…¥é˜Ÿã€‚

3.transmitæˆåŠŸåï¼Œtx_engineä¼šè¿”å›å‘é€ç»“æœï¼ˆé”™è¯¯ï¼Œé˜Ÿåˆ—ä¸ºç©ºï¼Œå‘é€æ­£ç¡®ï¼‰ï¼Œå‰ä¸¤ç§æƒ…å†µä¼šå°†å¯¹åº”è¡¨é¡¹å¤±èƒ½ï¼Œè®©å…¶æ— æ³•å†é‡æ–°å…¥é˜Ÿï¼Œ**ç›´åˆ°å¯¹åº”é˜Ÿåˆ—æœ‰æ–°çš„doorbelläº‹ä»¶ã€‚**åä¸€ç§æƒ…å†µä¼šé‡æ–°æ¿€æ´»è¯¥é˜Ÿåˆ—ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—æœªåœ¨æ•°æ®ç»“æ„ä¸­ï¼Œå…¥é˜Ÿã€‚

---

**æ€»ä½“æ¥è¯´ï¼Œé™¤äº†ä¼˜å…ˆçº§ä¸¢å¤±ç°è±¡ï¼Œå…¶ä»–çš„ç¬¦åˆvPIFOçš„å¤–éƒ¨æ¡ä»¶ã€‚**

---

**æ–°æ¶æ„-v2è®¾è®¡**

![å›¾ç‰‡1.svg](%25E5%259B%25BE%25E7%2589%25871.svg)

**5.æ¥å£è®¾è®¡**

æ— è®ºæ˜¯vPIFOè¿˜æ˜¯BMW-Treeï¼Œéƒ½åº”è¯¥ä½¿ç”¨æ­¤AXIStreamæ¥å£ï¼š

```verilog

bmw_tree #(
    .DEPTH(2**QUEUE_INDEX_WIDTH),
    .DATA_WIDTH(QUEUE_INDEX_WIDTH),
    .PRIORITY_WIDTH(PRIORITY_WIDTH),
    .KEEP_ENABLE(0),
    .KEEP_WIDTH(1),
    .LAST_ENABLE(0),
    .ID_ENABLE(0),
    .DEST_ENABLE(0),
    .USER_ENABLE(0),
    .FRAME_FIFO(0)
)
u_pifo (
    .clk(clk),
    .rst(rst),

    // AXI input
    .s_axis_tdata(axis_scheduler_pifo_in_queue),
    .s_axis_tpriority(axis_scheduler_pifo_in_priority),
    .s_axis_tkeep(0),
    .s_axis_tvalid(axis_scheduler_pifo_in_valid),
    .s_axis_tready(axis_scheduler_pifo_in_ready),
    .s_axis_tlast(0),
    .s_axis_tid(0),
    .s_axis_tdest(0),
    .s_axis_tuser(0),

    // AXI output
    .m_axis_tdata(axis_scheduler_pifo_out_queue),
    .m_axis_tpriority(axis_scheduler_pifo_out_priority),    //convenient for debugging, and rescheduling.
    .m_axis_tkeep(),
    .m_axis_tvalid(axis_scheduler_pifo_out_valid),
    .m_axis_tready(axis_scheduler_pifo_out_ready),
    .m_axis_tlast(),
    .m_axis_tid(),
    .m_axis_tdest(),
    .m_axis_tuser(),

    // Status
    .status_overflow(),
    .status_bad_frame(),
    .status_good_frame()
);
//å¦‚ä½•ç§»æ¤æ­¤æ¥å£
//æ­£ç¡®å¤„ç†validå’Œreadyé€»è¾‘
//æ­¤æ¥å£ä¸ºåŸAXIS-FIFOæ¥å£ï¼Œå…¶å®ä¸ç”¨ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ä¸ºäº†ç»Ÿä¸€å’Œç¾è§‚ï¼Œå¸Œæœ›å¯ä»¥æ”¹æˆè¿™ç§çš„ã€‚
```

## 5.ä»£ç å®ç°

è§ä»“åº“ã€‚

## 6. æ¢³ç†Corundumæ•´ä½“æ¶æ„

### 6.1 Corundumä¸å…¶ä»–å¼€æºç½‘å¡å¯¹æ¯”

Corundumï¼Œå®Œå…¨å¼€æºçš„100Gbpsç½‘å¡ï¼Œä¸»è¦è®¾è®¡å®ç°äº†ä¸€ç§å¯é…ç½®çš„DMAã€‚

**ç›¸æ¯”äºNetFPGA,**NetFPGAæ›´é¢å‘äº¤æ¢å’Œåˆ†ç»„å¤„ç†ï¼Œcorundumæ—¨åœ¨å……å½“ç½‘å¡ã€‚ç”±äºå†å²åŸå› ï¼ŒNetFPGAç½‘å¡å‚è€ƒè®¾è®¡ä¾èµ–äºXDMAå’ŒRIFFAä½œä¸ºä¸»æœºæ¥å£ï¼Œè¿™ä¸¤ç§æ¥å£éƒ½ä¸æ˜¯ä¸ºç½‘ç»œåº”ç”¨è®¾è®¡çš„ï¼Œå› æ­¤æ€§èƒ½ä¸ä½³ã€‚

**ç›¸æ¯”äºXilinxçš„OpenNIC**,OpenNIC å’Œ Corundum æœ€å¤§çš„åŒºåˆ«åœ¨äº OpenNIC ä½¿ç”¨ Xilinx QDMA IP å†…æ ¸ä½œä¸ºä¸»æœºæ¥å£ï¼Œè€Œ Corundum ä½¿ç”¨å®Œå…¨å®šåˆ¶çš„ DMA å­ç³»ç»Ÿã€‚å› æ­¤ï¼ŒOpenNIC å—ç›Šäºå¯¹ QDMA IP çš„ç°æœ‰è½¯ä»¶æ”¯æŒï¼ŒåŒ…æ‹¬ OpenNIC ä¸­çš„ Linux ç½‘ç»œè®¾å¤‡é©±åŠ¨ç¨‹åºå’Œ DPDK PMDã€‚å¦ä¸€æ–¹é¢ï¼ŒCorundum ä¸­çš„ DMA å­ç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œæ”¯æŒscatter/gather DMA ä»¥é™ä½ CPU å¼€é”€ï¼Œä»¥åŠå¯ç”¨äºä½œä¸ºç”¨æˆ·é€»è¾‘çš„æ¥å£ï¼Œå¹¶ä¸ºæ‰€æœ‰æ•°æ®åŒ…æä¾› PTP æ—¶é—´æˆ³çš„per-packet metadataã€‚

**Corundum è¿˜æ”¯æŒ** TCP/UDP/IP æ ¡éªŒå’Œå¸è½½ï¼Œä»¥åŠç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬é€šè¿‡ PCIe è¿›è¡Œå›ºä»¶æ›´æ–°å’Œä¸å…‰æ”¶å‘å™¨é€šä¿¡ã€‚æ­¤å¤–ï¼ŒCorundum æ”¯æŒå„ç§å¼€ç®±å³ç”¨çš„ FPGA å’Œ FPGA æ¿ï¼Œè€Œ OpenNIC ä»…é™äº QDMA æ”¯æŒçš„è®¾å¤‡ï¼Œä¸åŒ…æ‹¬å„ç§æ¿çš„å‚è€ƒè®¾è®¡ã€‚OpenNIC å’Œ Corundum éƒ½å¯ä»¥æ”¯æŒæµå¼æ•°æ®åŒ…å¤„ç†åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬åœ¨ç”¨æˆ·é€»è¾‘ä¸­å®ç°çš„ P4 ç¨‹åºã€‚å¸‚é¢ä¸Šå·²ç»æœ‰äº†ç›¸å½“ä¸€éƒ¨åˆ†æ™ºèƒ½ç½‘å¡ï¼ŒåŒ…æ‹¬Tonicã€PANICã€NanoPUã€‚Corundumåˆ«äºæ‰€æœ‰è¿™äº›é¡¹ç›®ï¼Œå› ä¸ºå®ƒæ˜¯å®Œå…¨å¼€æºçš„ï¼Œå¯ä»¥è¿è¡Œåœ¨ä¸€ä¸ªæ ‡å‡†çš„ä¸»æœºç½‘ç»œæ ˆï¼Œåœ¨å®é™…çš„ç‰©ç†é“¾è·¯ã€‚å®ƒæä¾›äº†æ•°åƒä¸ªä¼ è¾“é˜Ÿåˆ—å’Œå¯æ‰©å±•çš„ä¼ è¾“è°ƒåº¦ç¨‹åºï¼Œç”¨äºæµçš„ç»†ç²’åº¦æ§åˆ¶ã€‚è¿™å°±ä¸ºå¼€å‘ç»“åˆäº†ç¡¬ä»¶å’Œè½¯ä»¶åŠŸèƒ½çš„ç½‘ç»œåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„å¼€æºå¹³å°ã€‚

### 6.2 Corundumæ•´ä½“æ¶æ„å›¾

**ç¡¬ä»¶é˜Ÿåˆ—çŠ¶æ€å­˜å‚¨**ï¼šCorundumåœ¨FPGAå—RAMä¸­é«˜æ•ˆå­˜å‚¨ç¡¬ä»¶é˜Ÿåˆ—çŠ¶æ€ï¼Œæ”¯æŒæ•°åƒä¸ªå¯å•ç‹¬æ§åˆ¶çš„é˜Ÿåˆ—ã€‚è¿™äº›é˜Ÿåˆ—ä¸æ¥å£å…³è”ï¼Œæ¯ä¸ªæ¥å£å¯ä»¥æœ‰å¤šä¸ªç«¯å£ï¼Œæ¯ä¸ªç«¯å£éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ä¼ è¾“è°ƒåº¦å™¨ã€‚è¿™ç§è®¾è®¡å…è®¸å¯¹æ•°æ®åŒ…ä¼ è¾“è¿›è¡Œæå…¶ç»†ç²’åº¦çš„æ§åˆ¶ã€‚
**è°ƒåº¦æ¨¡å—è®¾è®¡**ï¼šè°ƒåº¦æ¨¡å—è®¾è®¡ä¸ºå¯ä¿®æ”¹æˆ–å®Œå…¨æ¢å‡ºï¼Œä»¥å®ç°ä¸åŒçš„ä¼ è¾“è°ƒåº¦æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å®éªŒæ€§è°ƒåº¦å™¨ã€‚ç»“åˆPTPï¼ˆç²¾ç¡®æ—¶é—´åè®®ï¼‰æ—¶é—´åŒæ­¥ï¼ˆPTP hardware clockï¼‰ï¼Œè¿™ä½¿å¾—åŸºäºæ—¶é—´çš„è°ƒåº¦æˆä¸ºå¯èƒ½ï¼ŒåŒ…æ‹¬é«˜ç²¾åº¦TDMAï¼ˆæ—¶åˆ†å¤šå€ï¼‰ã€‚
**æ¨¡å—åŒ–å’Œå‚æ•°åŒ–è®¾è®¡**ï¼šCorundumçš„è®¾è®¡æ˜¯æ¨¡å—åŒ–çš„ï¼Œé«˜åº¦å‚æ•°åŒ–ã€‚è®¸å¤šé…ç½®å’Œç»“æ„é€‰é¡¹å¯ä»¥åœ¨ç»¼åˆæ—¶é€šè¿‡Verilogå‚æ•°è®¾ç½®ï¼ŒåŒ…æ‹¬æ¥å£å’Œç«¯å£æ•°é‡ã€é˜Ÿåˆ—æ•°é‡ã€å†…å­˜å¤§å°ç­‰ã€‚è¿™äº›è®¾è®¡å‚æ•°åœ¨é…ç½®å¯„å­˜å™¨ä¸­æš´éœ²ï¼Œé©±åŠ¨ç¨‹åºè¯»å–è¿™äº›å¯„å­˜å™¨ä»¥ç¡®å®šNICï¼ˆç½‘ç»œæ¥å£å¡ï¼‰é…ç½®ï¼Œä½¿å¾—ç›¸åŒçš„é©±åŠ¨ç¨‹åºå¯ä»¥æ”¯æŒè®¸å¤šä¸åŒçš„æ¿å¡å’Œé…ç½®ï¼Œæ— éœ€ä¿®æ”¹ã€‚
**é«˜levelæ¦‚è¿°**ï¼šCorundum NICï¼ˆç½‘ç»œæ¥å£å¡ï¼‰çš„å—å›¾å±•ç¤ºäº†NICçš„å‡ ä¸ªå±‚çº§ã€‚é¡¶çº§æ¨¡å—ä¸»è¦åŒ…å«supportå’Œæ¥å£ç»„ä»¶ï¼ŒåŒ…æ‹¬PCI Expressç¡¬IPæ ¸å¿ƒå’Œä»¥å¤ªç½‘æ¥å£ç»„ä»¶ï¼ˆåŒ…æ‹¬MACã€PHYå’Œç›¸å…³çš„ä¸²è¡Œå™¨ï¼‰ï¼Œä»¥åŠä¸€ä¸ªmqnic_coreé¡¶å±‚ï¼ˆwrapperï¼‰å®ä¾‹ï¼Œæä¾›DMAæ¥å£ã€‚mqnic_coreæ ¸å¿ƒæ¨¡å—åŒ…å«PTPæ—¶é’Ÿï¼ˆmqnic_ptpï¼‰ã€APPéƒ¨åˆ†ï¼ˆmqnic_app_blockï¼‰å’Œä¸€ä¸ªæˆ–å¤šä¸ªmqnic_interfaceæ¨¡å—å®ä¾‹ã€‚æ¯ä¸ªæ¥å£æ¨¡å—å¯¹åº”äºæ“ä½œç³»ç»Ÿçº§åˆ«çš„ç½‘ç»œæ¥å£ï¼ˆä¾‹å¦‚`eth0`ï¼‰ï¼ŒåŒ…å«é˜Ÿåˆ—ç®¡ç†é€»è¾‘ã€æè¿°ç¬¦ï¼ˆDescï¼‰å’Œå®Œæˆå¤„ç†é€»è¾‘ï¼ˆCplï¼‰ã€ä¼ è¾“è°ƒåº¦å™¨(Sched)ã€ä¼ è¾“ï¼ˆTXï¼‰å’Œæ¥æ”¶å¼•æ“ï¼ˆRXï¼‰ã€ä¼ è¾“å’Œæ¥æ”¶æ•°æ®è·¯å¾„ï¼ˆIngresså’ŒEgressï¼‰ï¼Œä»¥åŠç”¨äºåœ¨DMAæ“ä½œæœŸé—´ä¸´æ—¶å­˜å‚¨è¿›å‡ºæ•°æ®åŒ…çš„ä¸´æ—¶RAMã€‚é˜Ÿåˆ—ç®¡ç†é€»è¾‘ç»´æŠ¤æ‰€æœ‰NICé˜Ÿåˆ—çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ä¼ è¾“ã€ä¼ è¾“å®Œæˆã€æ¥æ”¶ã€æ¥æ”¶å®Œæˆå’Œäº‹ä»¶é˜Ÿåˆ—ã€‚
**è°ƒåº¦å™¨**ï¼šå¯¹äºæ¯ä¸ªæ¥å£ï¼Œæ¥å£æ¨¡å—ä¸­çš„ä¼ è¾“è°ƒåº¦å™¨ï¼ˆmqnic_tx_scheduler_blockï¼‰å†³å®šå“ªäº›é˜Ÿåˆ—è¢«æŒ‡å®šç”¨äºä¼ è¾“ã€‚ä¼ è¾“è°ƒåº¦å™¨ç”Ÿæˆå‘½ä»¤ç»™TX_engineï¼Œè¯¥å¼•æ“åè°ƒä¼ è¾“æ•°æ®è·¯å¾„ä¸Šçš„æ“ä½œã€‚è°ƒåº¦æ¨¡å—æ˜¯ä¸€ä¸ªçµæ´»çš„åŠŸèƒ½å—ï¼Œå¯ä»¥ä¿®æ”¹æˆ–æ›¿æ¢ä»¥æ”¯æŒä»»æ„è°ƒåº¦ï¼Œå¯èƒ½æ˜¯äº‹ä»¶é©±åŠ¨çš„ã€‚é»˜è®¤çš„è°ƒåº¦å®ç°æ˜¯ç®€å•çš„è½®è¯¢ï¼ˆround-robinï¼‰ã€‚
**æ¥æ”¶æ–¹å‘**ï¼šä¼ å…¥çš„æ•°æ®åŒ…é€šè¿‡ä¸€ä¸ªflow hash moduleä»¥ç¡®å®šç›®æ ‡æ¥æ”¶é˜Ÿåˆ—ï¼Œå¹¶ä¸ºæ¥æ”¶å¼•æ“ç”Ÿæˆå‘½ä»¤ï¼Œè¯¥å¼•æ“åè°ƒæ¥æ”¶æ•°æ®è·¯å¾„ä¸Šçš„æ“ä½œã€‚å› ä¸ºåŒä¸€æ¥å£æ¨¡å—ä¸­çš„æ‰€æœ‰ç«¯å£å…±äº«ç›¸åŒçš„ä¸€ç»„æ¥æ”¶é˜Ÿåˆ—ï¼Œä¸åŒç«¯å£ä¸Šçš„ä¼ å…¥æµåˆå¹¶åˆ°åŒä¸€ç»„é˜Ÿåˆ—ä¸­ã€‚
**APPå—**ï¼šæä¾›äº†ä¸€ä¸ªAPPå—ï¼ˆmqnic_app_blockï¼‰ç”¨äºå®šåˆ¶ï¼ŒåŒ…æ‹¬æ•°æ®åŒ…å¤„ç†ã€è·¯ç”±å’Œç½‘ç»œå†…è®¡ç®—åº”ç”¨ã€‚APPå—è¿æ¥åˆ°å‡ ä¸ªä¸åŒçš„å­ç³»ç»Ÿã€‚
**NICç»„ä»¶çš„äº’è¿**ï¼šNICç»„ä»¶é€šè¿‡å‡ ç§ä¸åŒçš„æ¥å£äº’è¿ï¼ŒåŒ…æ‹¬AXI liteã€AXI streamå’Œ**DMAæ“ä½œçš„è‡ªå®šä¹‰ã€‚**

**åˆ†æ®µå†…å­˜æ¥å£**ï¼ˆç§»æ¤æ—¶éœ€è¦ç ”ç©¶å…¶æ¥å£æ„é€ ï¼‰:AXI liteç”¨äºä»é©±åŠ¨ç¨‹åºåˆ°NICçš„æ§åˆ¶è·¯å¾„ï¼Œç”¨äºåˆå§‹åŒ–å’Œé…ç½®NICç»„ä»¶ä»¥åŠåœ¨ä¼ è¾“å’Œæ¥æ”¶æ“ä½œä¸­æ§åˆ¶é˜Ÿåˆ—æŒ‡é’ˆã€‚AXI streamæ¥å£ç”¨äºåœ¨NICå†…éƒ¨ä¼ è¾“æ•°æ®åŒ…åŒ–æ•°æ®ã€‚åˆ†æ®µå†…å­˜æ¥å£ç”¨äºè¿æ¥PCIe DMAæ¥å£åˆ°NICæ•°æ®è·¯å¾„ä»¥åŠæè¿°ç¬¦ï¼ˆDescï¼‰å’Œå®Œæˆå¤„ç†é€»è¾‘ã€‚
**æ—¶é’ŸåŸŸ**ï¼šå¤§å¤šæ•°NICé€»è¾‘åœ¨PCIeç”¨æˆ·æ—¶é’ŸåŸŸè¿è¡Œï¼Œå¯¹äºæ‰€æœ‰å½“å‰è®¾è®¡å˜ä½“æ¥è¯´ï¼Œåä¹‰ä¸Šæ˜¯250 MHzã€‚è€Œä½¿ç”¨å¼‚æ­¥FIFOä¸MACæ¥å£ï¼Œè¿™äº›MACåœ¨é€‚å½“çš„ä¸²è¡Œå™¨ä¼ è¾“å’Œæ¥æ”¶æ—¶é’ŸåŸŸä¸­è¿è¡Œâ€”â€”10Gä¸º156.25 MHzï¼Œ25Gä¸º390.625 MHzï¼Œ100Gä¸º322.265625 MHzã€‚

### 6.3 Corundumè®ºå›

Corundumçš„zulipç¤¾åŒº

[](https://corundum.zulipchat.com/)

Corundumçš„GitHubåœ°å€

[https://github.com/corundum/corundum](https://github.com/corundum/corundum)

Corundumçš„æœ€æ–°branchåœ°å€

[https://github.com/alexforencich/corundum](https://github.com/alexforencich/corundum)

Corundumçš„Wiki Document

[Contents â€” Corundum documentation](https://docs.corundum.io/en/latest/contents.html)

### 6.4 å¦‚ä½•å£°æ˜ç‰ˆæƒ

ä»¥ä¸‹ä¸¤è€…è‡³å°‘å–å…¶ä¸€ï¼Œå‰è€…æ˜¯å¿…é¡»çš„ï¼š

1.å¼•ç”¨ä¸¤ç¯‡paperä¹‹ä¸€ï¼š

`@inproceedings{forencich2020fccm,
    author = {Alex Forencich and Alex C. Snoeren and George Porter and George Papen},
    title = {Corundum: An Open-Source {100-Gbps} {NIC}},
    booktitle = {28th IEEE International Symposium on Field-Programmable Custom Computing Machines},
    year = {2020},
}

@phdthesis{forencich2020thesis,
    author = {John Alexander Forencich},
    title = {System-Level Considerations for Optical Switching in Data Center Networks},
    school = {UC San Diego},
    year = {2020},
    url = {https://escholarship.org/uc/item/3mc9070t},
}`

2.Githubé¡¹ç›®linkåˆ°corundumå·¥ç¨‹ã€‚

## 7. Corundumåœ¨transmissionè¿‡ç¨‹ä¸­åŒ…çš„ç§»åŠ¨è·¯å¾„

### 7.1 é©±åŠ¨é˜¶æ®µ

**1.Linuxå†…æ ¸è°ƒç”¨**ï¼šLinuxå†…æ ¸é€šè¿‡`ndo_start_xmit()`è°ƒç”¨`mqnic_start_xmit()`å‡½æ•°ï¼Œä¼ é€’ä¸€ä¸ª`sk_buff`ç»“æ„ä½“ï¼Œè¡¨ç¤ºè¦å‘é€çš„æ•°æ®åŒ…ã€‚
2.**é©±åŠ¨ç¨‹åºç¡®å®šé˜Ÿåˆ—**ï¼š`mqnic_start_xmit()`å‡½æ•°ç¡®å®šæ•°æ®åŒ…çš„ç›®æ ‡å‘é€é˜Ÿåˆ—ï¼Œä½¿ç”¨`skb_get_queue_mapping`å‡½æ•°ã€‚

> ä¸‹æ–‡åŒ…å«äº†å¦‚ä½•æ ¹æ®skbå†³å®šå‘é€åˆ°å“ªä¸ªqueue:[ç½‘å¡é©±åŠ¨æ”¶å‘åŒ…sk_buffç›¸å…³åˆ†æ_ç½‘å¡ skb-CSDNåšå®¢](https://blog.csdn.net/weixin_48329334/article/details/140716785)
> 

skbçš„ç»“æ„ï¼š[blog.csdn.net/YuZhiHui_No1/article/details/38666589](https://blog.csdn.net/YuZhiHui_No1/article/details/38666589)

3.**æ—¶é—´æˆ³æ ‡è®°**ï¼šå¦‚æœéœ€è¦ï¼Œ`mqnic_start_xmit()`å‡½æ•°ä¼šä¸º`sk_buff`æ‰“ä¸Š**æ—¶é—´æˆ³**æ ‡è®°ã€‚ï¼ˆPTPï¼‰
4.**ç”Ÿæˆæ ¡éªŒå’Œå‘½ä»¤**ï¼š`mqnic_start_xmit()`å‡½æ•°ç”Ÿæˆç¡¬ä»¶IPæ ¡éªŒå’Œå‘½ä»¤ï¼Œå¹¶å†™å…¥æè¿°ç¬¦ã€‚
5.**å†™å…¥`sk_buff`å¼•ç”¨**ï¼š`mqnic_map_skb()`å‡½æ•°åœ¨`ring->tx_info`ä¸­å†™å…¥`sk_buff`çš„å¼•ç”¨ã€‚
6.**ç”ŸæˆDMAæ˜ å°„**ï¼š`mqnic_map_skb()`å‡½æ•°ä¸º`sk_buff`ç”ŸæˆDMAæ˜ å°„ï¼ˆä½¿ç”¨`skb_frag_dma_map()`æˆ–`dma_map_single()`ï¼‰ï¼Œå¹¶æ„å»ºæè¿°ç¬¦ã€‚
7.**å…¥é˜Ÿæ•°æ®åŒ…**ï¼š`mqnic_start_xmit()`å‡½æ•°é€šè¿‡å¢åŠ ç”Ÿäº§è€…æŒ‡é’ˆçš„æœ¬åœ°å‰¯æœ¬æ¥å…¥é˜Ÿæ•°æ®åŒ…ã€‚
8.**æ›´æ–°ç”Ÿäº§è€…æŒ‡é’ˆ(producer consumer)**ï¼šåœ¨ä¸€æ‰¹æ•°æ®åŒ…å¤„ç†ç»“æŸåï¼Œ`mqnic_start_xmit()`å‡½æ•°é€šè¿‡MMIOå°†æ›´æ–°åçš„ç”Ÿäº§è€…æŒ‡é’ˆå†™å…¥ç½‘å¡ã€‚

![image/image.png](image%206.png)

### 7.2 queue manageré˜¶æ®µ

9.**queue_managerå¤„ç†**ï¼šMMIOå†™å…¥åˆ°è¾¾é˜Ÿåˆ—ç®¡ç†å™¨ï¼ˆé€šè¿‡PCIeé‡‘æ‰‹æŒ‡ï¼‰ï¼Œé€šè¿‡AXI Liteæ¥å£ã€‚
10.**ç”Ÿæˆé—¨é“ƒäº‹ä»¶**ï¼šqueue_manageræ›´æ–°ç”Ÿäº§è€…æŒ‡é’ˆå¹¶ç”Ÿæˆé—¨é“ƒäº‹ä»¶ç»™tx-schedã€‚

### 7.3 **è°ƒåº¦å™¨(TX-Sched)é˜¶æ®µ**

11.**ç«¯å£è°ƒåº¦å™¨å¤„ç†é—¨é“ƒäº‹ä»¶**ï¼šé—¨é“ƒäº‹ä»¶åˆ°è¾¾ç«¯å£è°ƒåº¦å™¨`tx_scheduler_rr`ã€‚

12.**æ ‡è®°é˜Ÿåˆ—ä¸ºæ´»è·ƒ**ï¼šè°ƒåº¦å™¨å°†é˜Ÿåˆ—æ ‡è®°ä¸ºæ´»è·ƒï¼Œå¹¶åœ¨å¿…è¦æ—¶è¿›è¡Œè°ƒåº¦ã€‚

13.**å†³å®šå‘é€æ•°æ®åŒ…**ï¼šè°ƒåº¦å™¨å†³å®šå‘é€ä¸€ä¸ªæ•°æ®åŒ…ã€‚

14.**ç”Ÿæˆä¼ è¾“è¯·æ±‚**ï¼šè°ƒåº¦å™¨ç”Ÿæˆä¼ è¾“è¯·æ±‚ï¼Œé€šè¿‡`m_axis_tx_req_*`æ¥å£ã€‚

### 7.4 **TX-Engineé˜¶æ®µ**

15.**TX_engineæ¥æ”¶è¯·æ±‚**ï¼šå‘é€è¯·æ±‚åˆ°è¾¾TX_engineã€‚
16.**TX_engineè¯·æ±‚æè¿°ç¬¦**ï¼šTX_engineå‘å‡ºæè¿°ç¬¦è¯·æ±‚ã€‚

### **7.5 Desc_fetchå‘å‡ºå‡ºé˜Ÿè¯·æ±‚**

17.**desc fetchå¤„ç†è¯·æ±‚**ï¼šæè¿°ç¬¦è¯·æ±‚åˆ°è¾¾`desc_fetch`ã€‚

18.**å‘å‡ºå‡ºé˜Ÿè¯·æ±‚**ï¼šdesc_fetchå‘queue_managerå‘å‡ºå‡ºé˜Ÿè¯·æ±‚ã€‚

### **7.6 queue_managerå‡ºé˜Ÿé˜¶æ®µ**

19.**queue_managerå¤„ç†å‡ºé˜Ÿè¯·æ±‚**ï¼šqueue_manageræ¥æ”¶å‡ºé˜Ÿè¯·æ±‚ã€‚

20.**é˜Ÿåˆ—éç©ºåˆ™å¼€å§‹å‡ºé˜Ÿæ“ä½œ**ï¼šå¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œqueue_managerå¼€å§‹å‡ºé˜Ÿæ“ä½œã€‚

21.**queue_managerå‘é€å“åº”**ï¼šqueue_managerå‘é€åŒ…å«æ“ä½œçŠ¶æ€å’ŒDMAåœ°å€çš„å“åº”ã€‚

### **7.7 desc_fetchå‘å‡ºDMAè¯»è¯·æ±‚**

22.**desc_fetchæ¥æ”¶å“åº”**ï¼šå“åº”åˆ°è¾¾desc_fetchã€‚

23.**æŠ¥å‘Šæè¿°ç¬¦è·å–çŠ¶æ€**ï¼šdesc_fetchæŠ¥å‘Šæè¿°ç¬¦è·å–çŠ¶æ€ã€‚

24.**å‘å‡ºDMAè¯»è¯·æ±‚**ï¼šdesc_fetchå‘å‡ºDMAè¯»è¯·æ±‚ã€‚

### **7.8 DMAé˜¶æ®µï¼ˆè·¨å¤šæ¨¡å—ï¼‰**

25.**DMAè¯»æ¥å£å¤„ç†è¯·æ±‚**ï¼šè¯·æ±‚åˆ°è¾¾DMAè¯»æ¥å£`dma_if_pcie_rd`ã€‚

26.**å‘å‡ºPCIeè¯»è¯·æ±‚**ï¼šDMAè¯»æ¥å£å‘å‡ºPCIeè¯»è¯·æ±‚ã€‚

27.**è¯»æ•°æ®å†™å…¥DMA RAM**ï¼šè¯»å›æè¿°ç¬¦ï¼Œå¹¶å†™å…¥desc_fetchçš„æœ¬åœ°DMA RAMã€‚

28.**å‘å‡ºçŠ¶æ€æ¶ˆæ¯**ï¼šDMAè¯»æ¥å£å‘å‡ºçŠ¶æ€æ¶ˆæ¯ã€‚

29.**å‘å‡ºå‡ºé˜Ÿç¡®è®¤æ¶ˆæ¯**ï¼šdesc_fetchå‘å‡ºå‡ºé˜Ÿç¡®è®¤æ¶ˆæ¯ã€‚

30.**queue_manageræäº¤å‡ºé˜Ÿæ“ä½œ**ï¼šqueue_manageræäº¤å‡ºé˜Ÿæ“ä½œå¹¶æ›´æ–°æ¶ˆè´¹è€…æŒ‡é’ˆï¼ˆconsumer pointerï¼‰ã€‚

31.**å†…éƒ¨DMAæ¨¡å—è¯»æè¿°ç¬¦**ï¼šdesc_fetchå‘å…¶å†…éƒ¨DMAæ¨¡å—å‘å‡ºè¯»è¯·æ±‚ã€‚

32.**æè¿°ç¬¦é€šè¿‡AXI-Streamä¼ è¾“**ï¼šå†…éƒ¨DMAæ¨¡å—è¯»å–æè¿°ç¬¦å¹¶é€šè¿‡AXI-Streamä¼ è¾“ã€‚

33.**æè¿°ç¬¦åˆ°è¾¾TX_engine**ï¼šæè¿°ç¬¦åˆ°è¾¾TX_engineã€‚

34.**å­˜å‚¨æè¿°ç¬¦æ•°æ®**ï¼šTX_engineå­˜å‚¨æè¿°ç¬¦æ•°æ®ã€‚

35.**TX_engineå‘å‡ºDMAè¯»è¯·æ±‚**ï¼šTX_engineå‘å‡ºDMAè¯»è¯·æ±‚ã€‚

36.**DMAè¯»æ¥å£å¤„ç†è¯·æ±‚**ï¼šè¯·æ±‚åˆ°è¾¾DMAè¯»æ¥å£ã€‚

37.**å‘å‡ºPCIeè¯»è¯·æ±‚**ï¼šDMAè¯»æ¥å£å‘å‡ºPCIeè¯»è¯·æ±‚ã€‚

38.**è¯»æ•°æ®å†™å…¥æ¥å£DMA RAM**ï¼šè¯»æ•°æ®ä»¥å®Œæˆæ•°æ®åŒ…çš„å½¢å¼è¿”å›ï¼Œå¹¶å†™å…¥æ¥å£æœ¬åœ°DMA RAMã€‚

39.**å‘å‡ºçŠ¶æ€æ¶ˆæ¯**ï¼šDMAè¯»æ¥å£å‘å‡ºçŠ¶æ€æ¶ˆæ¯ã€‚

40.**TX_engineå‘å‡ºæ¥å£DMAå¼•æ“è¯»è¯·æ±‚**ï¼šTX_engineå‘æ¥å£DMAå¼•æ“å‘å‡ºè¯»è¯·æ±‚ã€‚

41.**TX_engineå‘å‡ºæ ¡éªŒå’Œå‘½ä»¤**ï¼šTX_engineå‘å‡ºä¼ è¾“æ ¡éªŒå’Œå‘½ä»¤ã€‚

42.**æ¥å£DMAæ¨¡å—å¤„ç†æ•°æ®**ï¼šæ¥å£DMAæ¨¡å—ä»æ¥å£æœ¬åœ°DMA RAMè¯»å–æ•°æ®åŒ…æ•°æ®ï¼Œå¹¶é€šè¿‡AXI-Streamä¼ è¾“ã€‚

### **7.9 egressã€checksumé˜¶æ®µ**

43.**æ•°æ®åŒ…å‡ºç«™å¤„ç†**ï¼šæ•°æ®åŒ…é€šè¿‡`mqnic_egress`è¿›è¡Œå‡ºç«™å¤„ç†ã€‚

44.**è®¡ç®—å¹¶æ’å…¥æ ¡éªŒå’Œ**ï¼štx_checksumæ¨¡å—è®¡ç®—å¹¶æ’å…¥æ ¡éªŒå’Œã€‚

### **7.10 APPæ¨¡å—é˜¶æ®µ**

45.**æ•°æ®å‘ˆç°ç»™APPéƒ¨åˆ†**ï¼šæ•°æ®å‘ˆç°ç»™`mqnic_app_block`çš„APPéƒ¨åˆ†ã€‚

46.**æ•°æ®ä»APPéƒ¨åˆ†è¿”å›**ï¼šæ•°æ®ä»APPéƒ¨åˆ†è¿”å›ã€‚

47.**æ•°æ®è¿›å…¥å‘é€FIFOæ¨¡å—**ï¼šæ•°æ®è¿›å…¥æ¯ä¸ªæ¥å£çš„å‘é€FIFOæ¨¡å—ï¼Œå¹¶è¢«åˆ†é…åˆ°per-portã€per-traffic-classçš„FIFOä¸­ã€‚

48.**æ•°æ®å‘ˆç°ç»™åŒæ­¥å‘é€APPéƒ¨åˆ†**ï¼šæ•°æ®å‘ˆç°ç»™`mqnic_app_block`çš„åŒæ­¥å‘é€APPéƒ¨åˆ†ã€‚

49.**æ•°æ®ä»åŒæ­¥APPéƒ¨åˆ†è¿”å›**ï¼šæ•°æ®ä»**åŒæ­¥å‘é€APP**éƒ¨åˆ†è¿”å›ã€‚

50.**æ•°æ®è¿›å…¥å¼‚æ­¥FIFOæ¨¡å—**ï¼šæ•°æ®è¿›å…¥æ¯ä¸ªç«¯å£çš„å¼‚æ­¥å‘é€FIFOæ¨¡å—ï¼Œå¹¶è¢«è½¬ç§»åˆ°MAC TXæ—¶é’ŸåŸŸã€‚

51.**æ•°æ®å‘ˆç°ç»™ç›´æ¥å‘é€APPéƒ¨åˆ†**ï¼šæ•°æ®å‘ˆç°ç»™`mqnic_app_block`çš„**ç›´æ¥å‘é€APP**éƒ¨åˆ†ã€‚

52.**æ•°æ®ä»ç›´æ¥å‘é€APPéƒ¨åˆ†è¿”å›**ï¼šæ•°æ®ä»**ç›´æ¥å‘é€APP**éƒ¨åˆ†è¿”å›ã€‚

53.**äºŒå±‚å‡ºç«™å¤„ç†**ï¼š`mqnic_l2_egress`è¿›è¡ŒäºŒå±‚å‡ºç«™å¤„ç†ã€‚

54.**æ•°æ®é€šè¿‡å‘é€æµæ¥å£ç¦»å¼€**ï¼šæ•°æ®é€šè¿‡å‘é€æµæ¥å£ç¦»å¼€ã€‚

55.**æ•°æ®åŒ…è¢«MACä¼ è¾“å¹¶æ‰“ä¸Šæ—¶é—´æˆ³**ï¼šæ•°æ®åŒ…è¢«MACä¼ è¾“å¹¶æ‰“ä¸Šæ—¶é—´æˆ³ã€‚

56.**æ—¶é—´æˆ³å’ŒTXæ ‡ç­¾é€šè¿‡å®Œæˆæµæ¥å£åˆ°è¾¾**ï¼šæ—¶é—´æˆ³å’ŒTXæ ‡ç­¾é€šè¿‡å®Œæˆæµæ¥å£åˆ°è¾¾ã€‚

57.**TX-Cplå‘ˆç°ç»™ç›´æ¥APPéƒ¨åˆ†**ï¼šTX-Cplå‘ˆç°ç»™`mqnic_app_block`çš„ç›´æ¥APPéƒ¨åˆ†ã€‚

58.**TX-Cplä»ç›´æ¥APPéƒ¨åˆ†è¿”å›**ï¼šTX-Cplä»ç›´æ¥APPéƒ¨åˆ†è¿”å›ã€‚

59.**TX-Cplè¿›å…¥å¼‚æ­¥FIFOæ¨¡å—**ï¼šTX-Cplè¿›å…¥æ¯ä¸ªç«¯å£çš„å¼‚æ­¥FIFOæ¨¡å—ï¼Œå¹¶è¢«è½¬ç§»åˆ°æ ¸å¿ƒæ—¶é’ŸåŸŸã€‚

60.**TX-Cplå‘ˆç°ç»™åŒæ­¥APPéƒ¨åˆ†**ï¼šTX-Cplå‘ˆç°ç»™`mqnic_app_block`çš„åŒæ­¥APPéƒ¨åˆ†ã€‚

61.**TX-Cplä»åŒæ­¥APPéƒ¨åˆ†è¿”å›**ï¼šTX-Cplä»åŒæ­¥APPéƒ¨åˆ†è¿”å›ã€‚

62.**TX-Cplè¿›å…¥å‘é€FIFOæ¨¡å—**ï¼šTX-Cplè¿›å…¥æ¯ä¸ªæ¥å£çš„å‘é€FIFOæ¨¡å—ï¼Œå¹¶è¢«æ”¾å…¥æ¯ä¸ªç«¯å£çš„FIFOä¸­ï¼Œç„¶åèšåˆæˆå•ä¸ªæµã€‚

63.**TX-Cplå‘ˆç°ç»™æ¥å£APPéƒ¨åˆ†**ï¼šTX-Cplå‘ˆç°ç»™`mqnic_app_block`çš„æ¥å£APPéƒ¨åˆ†ã€‚

64.**TX-Cplä»æ¥å£APPéƒ¨åˆ†è¿”å›**ï¼šTX-Cplä»æ¥å£APPéƒ¨åˆ†è¿”å›ã€‚

65.**TX-Cplåˆ°è¾¾TX_engine**ï¼šTX-Cplåˆ°è¾¾TX_engineã€‚

66.**TX_engineå‘å‡ºå®Œæˆå†™å…¥è¯·æ±‚**ï¼šTX_engineå‘å‡ºå®Œæˆå†™å…¥è¯·æ±‚ã€‚

### **7.11 å®Œæˆå†™å…¥æ¨¡å—ï¼ˆcpl_writeé˜¶æ®µï¼‰**

67.**å®Œæˆå†™å…¥æ¨¡å—å†™å…¥å®Œæˆæ•°æ®**ï¼šå®Œæˆå†™å…¥æ¨¡å—`cpl_write`å°†å®Œæˆæ•°æ®(æè¿°ç¬¦)å†™å…¥å…¶æœ¬åœ°DMA RAMã€‚

### **7.12 queue_managerå…¥é˜Ÿè¯·æ±‚**

68.**å‘å‡ºå…¥é˜Ÿè¯·æ±‚**ï¼šcpl_writeå‘å‡ºå…¥é˜Ÿè¯·æ±‚åˆ°TXCQã€‚

69.**å…¥é˜Ÿè¯·æ±‚åˆ°è¾¾TXCQ**ï¼šå…¥é˜Ÿè¯·æ±‚åˆ°è¾¾TXCQæ¨¡å—ã€‚

70.**å¼€å§‹å…¥é˜Ÿæ“ä½œ**ï¼šå¦‚æœé˜Ÿåˆ—æœªæ»¡ï¼Œqueue_managerå¼€å§‹å…¥é˜Ÿæ“ä½œã€‚

71.**å‘é€æ“ä½œçŠ¶æ€å’ŒDMAåœ°å€å“åº”**ï¼šTXCQå‘é€åŒ…å«æ“ä½œçŠ¶æ€å’ŒDMAåœ°å€çš„å“åº”ã€‚

72.**å“åº”åˆ°è¾¾cpl_write**ï¼šå“åº”åˆ°è¾¾cpl_writeã€‚

73.**æŠ¥å‘Šå®Œæˆå†™å…¥çŠ¶æ€**ï¼šcpl_writeæŠ¥å‘Šå®Œæˆå†™å…¥çŠ¶æ€ã€‚

74.**å‘å‡ºDMAå†™è¯·æ±‚**ï¼šcpl_writeå‘å‡ºDMAå†™è¯·æ±‚ã€‚

75.**DMAå†™æ¥å£å¤„ç†è¯·æ±‚**ï¼šè¯·æ±‚åˆ°è¾¾DMAå†™æ¥å£`dma_if_pcie_wr`ã€‚

76.**ä»cpl_writeè¯»å–å®Œæˆæ•°æ®**ï¼šDMAå†™æ¥å£ä»cpl_writeçš„æœ¬åœ°DMA RAMè¯»å–å®Œæˆæ•°æ®ã€‚

77.**å‘å‡ºPCIeå†™è¯·æ±‚**ï¼šDMAå†™æ¥å£å‘å‡ºPCIeå†™è¯·æ±‚ã€‚

78.**å‘å‡ºçŠ¶æ€æ¶ˆæ¯**ï¼šDMAå†™æ¥å£å‘å‡ºçŠ¶æ€æ¶ˆæ¯ã€‚

79.**å‘å‡ºå…¥é˜Ÿç¡®è®¤æ¶ˆæ¯**ï¼šcpl_writeå‘å‡ºå…¥é˜Ÿç¡®è®¤æ¶ˆæ¯ã€‚

80.**TXCQæäº¤å…¥é˜Ÿæ“ä½œ**ï¼šTXCQæäº¤å…¥é˜Ÿæ“ä½œå¹¶æ›´æ–°ç”Ÿäº§è€…æŒ‡é’ˆã€‚

81.**å‘å‡ºäº‹ä»¶ï¼ˆif armedï¼‰**ï¼šTXCQå‘å‡ºäº‹ä»¶ã€‚

### **7.13 cpl_writeå†æ¬¡å‘å‡ºå…¥é˜Ÿè¯·æ±‚**

82.**äº‹ä»¶åˆ°è¾¾cpl_write**ï¼šäº‹ä»¶åˆ°è¾¾cpl_writeã€‚

83.**å°†äº‹ä»¶æ•°æ®å†™å…¥æœ¬åœ°DMA RAM**ï¼šcpl_writeå°†äº‹ä»¶æ•°æ®å†™å…¥å…¶æœ¬åœ°DMA RAMã€‚

84.**å†æ¬¡å‘å‡ºå…¥é˜Ÿè¯·æ±‚**ï¼šcpl_writeå†æ¬¡å‘å‡ºå…¥é˜Ÿè¯·æ±‚åˆ°TXCQã€‚

85.**å…¥é˜Ÿè¯·æ±‚åˆ°è¾¾TXCQ**ï¼šå…¥é˜Ÿè¯·æ±‚åˆ°è¾¾TXCQæ¨¡å—ã€‚

87.**å¼€å§‹å…¥é˜Ÿæ“ä½œ**ï¼šå¦‚æœé˜Ÿåˆ—æœªæ»¡ï¼Œqueue_managerå¼€å§‹å…¥é˜Ÿæ“ä½œã€‚

88.**å‘é€æ“ä½œçŠ¶æ€å’ŒDMAåœ°å€å“åº”**ï¼šTXCQå‘é€åŒ…å«æ“ä½œçŠ¶æ€å’ŒDMAåœ°å€çš„å“åº”ã€‚

### **7.14 cpl_writeæŠ¥å‘Šå®Œæˆå†™å…¥çŠ¶æ€ï¼Œå‘å‡ºDMAå†™è¯·æ±‚**

89.**å“åº”åˆ°è¾¾cpl_write**ï¼šå“åº”åˆ°è¾¾cpl_writeã€‚

90.**æŠ¥å‘Šå®Œæˆå†™å…¥çŠ¶æ€**ï¼šcpl_writeæŠ¥å‘Šå®Œæˆå†™å…¥çŠ¶æ€ã€‚

91.**å‘å‡ºDMAå†™è¯·æ±‚**ï¼šcpl_writeå‘å‡ºDMAå†™è¯·æ±‚ã€‚

### 7.15 DMAå†™è¯·æ±‚ï¼ˆè·¨å¤šæ¨¡å—ï¼‰

92.**DMAå†™æ¥å£å¤„ç†è¯·æ±‚**ï¼šè¯·æ±‚åˆ°è¾¾DMAå†™æ¥å£ã€‚

93.**ä»cpl_writeè¯»å–äº‹ä»¶æ•°æ®**ï¼šDMAå†™æ¥å£ä»cpl_writeçš„æœ¬åœ°DMA RAMè¯»å–äº‹ä»¶æ•°æ®ã€‚

94.**å‘å‡ºPCIeå†™è¯·æ±‚**ï¼šDMAå†™æ¥å£å‘å‡ºPCIeå†™è¯·æ±‚ã€‚

95.**å‘å‡ºçŠ¶æ€æ¶ˆæ¯**ï¼šDMAå†™æ¥å£å‘å‡ºçŠ¶æ€æ¶ˆæ¯ã€‚

### **7.16 queue manageræäº¤å…¥é˜Ÿopï¼Œæ›´æ–°producer pointer**

96.**å‘å‡ºå…¥é˜Ÿç¡®è®¤æ¶ˆæ¯**ï¼šcpl_writeå‘å‡ºå…¥é˜Ÿç¡®è®¤æ¶ˆæ¯ã€‚

97.**TXCQæäº¤å…¥é˜Ÿæ“ä½œ**ï¼šTXCQæäº¤å…¥é˜Ÿæ“ä½œå¹¶æ›´æ–°ç”Ÿäº§è€…æŒ‡é’ˆã€‚

98.**å‘å‡ºä¸­æ–­ï¼ˆif armedï¼‰**ï¼šTXCQå‘å‡ºä¸­æ–­ã€‚

### **7.17 Linuxå†…æ ¸å¤„ç†**

99.**Linuxå†…æ ¸è°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åº**ï¼šLinuxå†…æ ¸è°ƒç”¨`mqnic_irq_handler()`ã€‚

100.**ä¸­æ–­å¤„ç†ç¨‹åºè°ƒç”¨äº‹ä»¶é˜Ÿåˆ—å¤„ç†ç¨‹åº**ï¼š`mqnic_irq_handler()`è°ƒç”¨äº‹ä»¶é˜Ÿåˆ—å¤„ç†ç¨‹åºã€‚

101.**å¤„ç†äº‹ä»¶é˜Ÿåˆ—**ï¼š`mqnic_process_eq()`å¤„ç†äº‹ä»¶é˜Ÿåˆ—ï¼Œå¹¶è°ƒç”¨é€‚å½“çš„å¤„ç†ç¨‹åºã€‚

102.**å¯ç”¨NAPIè½®è¯¢**ï¼š`mqnic_tx_irq()`å¯ç”¨NAPIè½®è¯¢ã€‚

103.**rearmsäº‹ä»¶é˜Ÿåˆ—ï¼ˆEQï¼‰**ï¼š`mqnic_eq_int()`rearmäº‹ä»¶é˜Ÿåˆ—ã€‚

104.**Linuxå†…æ ¸è°ƒç”¨NAPIè½®è¯¢å‡½æ•°**ï¼šLinuxå†…æ ¸è°ƒç”¨`mqnic_poll_tx_cq()`ã€‚

105.**å¤„ç†å®Œæˆé˜Ÿåˆ—**ï¼š`mqnic_poll_tx_cq()`è°ƒç”¨`mqnic_process_tx_cq()`å¤„ç†å®Œæˆé˜Ÿåˆ—ã€‚

106.**è¯»å–å®Œæˆé˜Ÿåˆ—producer pointer**ï¼š`mqnic_process_tx_cq()`ä»ç½‘å¡è¯»å–å®Œæˆé˜Ÿåˆ—producer pointerã€‚

107.**è¯»å–å®Œæˆè®°å½•**ï¼š`mqnic_process_tx_cq()`è¯»å–å®Œæˆè®°å½•ã€‚

108.**è¯»å–`sk_buff`**ï¼š `mqnic_process_tx_cq()`ä»`ring->tx_info`è¯»å–`sk_buff`ã€‚

109.**å®Œæˆå‘é€æ—¶é—´æˆ³æ“ä½œ**ï¼š`mqnic_process_tx_cq()`å®Œæˆå‘é€æ—¶é—´æˆ³æ“ä½œã€‚

110.**é‡Šæ”¾TXæè¿°ç¬¦**ï¼š`mqnic_process_tx_cq()`è°ƒç”¨`mqnic_free_tx_desc()`é‡Šæ”¾TXæè¿°ç¬¦ã€‚

111.**å–æ¶ˆæ˜ å°„`sk_buff`**ï¼š`mqnic_free_tx_desc()`å–æ¶ˆæ˜ å°„`sk_buff`ã€‚

112.**é‡Šæ”¾`sk_buff`**ï¼š`mqnic_free_tx_desc()`é‡Šæ”¾`sk_buff`ã€‚

113.**å‡ºé˜Ÿå®Œæˆè®°å½•**ï¼š`mqnic_process_tx_cq()`å‡ºé˜Ÿå®Œæˆè®°å½•ï¼Œé€šè¿‡å¢åŠ å®Œæˆé˜Ÿåˆ—æ¶ˆè´¹è€…æŒ‡é’ˆï¼ˆconsumer pointerï¼‰ã€‚

114.**å†™å…¥æ›´æ–°çš„consumer pointer**ï¼š`mqnic_process_tx_cq()`é€šè¿‡MMIOå†™å…¥æ›´æ–°çš„æ¶ˆè´¹è€…æŒ‡é’ˆï¼ˆconsumer pointerï¼‰ã€‚

115.**è¯»å–é˜Ÿåˆ—consumer pointer**ï¼š`mqnic_process_tx_cq()`ä»ç½‘å¡è¯»å–é˜Ÿåˆ—æ¶ˆè´¹è€…æŒ‡é’ˆï¼ˆconsumer pointerï¼‰ã€‚

116.**å¢åŠ ç¯å½¢æ¶ˆè´¹è€…æŒ‡é’ˆconsumer pointer**ï¼š`mqnic_process_tx_cq()`å¢åŠ ç¯å½¢æ¶ˆè´¹è€…æŒ‡é’ˆï¼ˆconsumer pointerï¼‰ï¼Œç”¨äºæœ‰åºé‡Šæ”¾æè¿°ç¬¦ã€‚

117.**å”¤é†’é˜Ÿåˆ—**ï¼š`mqnic_process_tx_cq()`å¦‚æœé˜Ÿåˆ—å·²åœæ­¢ï¼Œåˆ™å”¤é†’é˜Ÿåˆ—ã€‚

118.**ç¦ç”¨NAPIè½®è¯¢**ï¼š`mqnic_poll_tx_cq()`åœ¨ç©ºé—²æ—¶ç¦ç”¨NAPIè½®è¯¢ã€‚(`napi_complete()`)

119.**rearmedCQ**ï¼š`mqnic_poll_tx_cq()`rearms CQã€‚(`mqnic_arm_cq()`)

## 8. Corundumåœ¨receiveè¿‡ç¨‹ä¸­åŒ…çš„ç§»åŠ¨è·¯å¾„

### **8.1 åˆå§‹åŒ–ï¼ˆinitï¼‰**

1. `mqnic_activate_rx_ring()`ï¼šæ¿€æ´»æ¥æ”¶ç¯ï¼ˆringï¼‰ï¼Œè°ƒç”¨`mqnic_refill_rx_buffers()`æ¥å¡«å……æ¥æ”¶ç¼“å†²åŒºã€‚
2. `mqnic_refill_rx_buffers()`ï¼šä¸ºç¯ä¸­çš„æ¯ä¸ªç©ºä½ç½®è°ƒç”¨`mqnic_prepare_rx_desc()`æ¥å‡†å¤‡æ¥æ”¶æè¿°ç¬¦ï¼ˆdescï¼‰ã€‚
3. `mqnic_prepare_rx_desc()`ï¼šåˆ†é…å†…å­˜é¡µï¼Œæ˜ å°„é¡µé¢ï¼Œå¹¶å°†DMAæŒ‡é’ˆå’Œé•¿åº¦å†™å…¥æè¿°ç¬¦ã€‚

### **8.2 ä¸‰æ¬¡APPå¤„ç†**

1. æ•°æ®åŒ…è¢«MACå±‚æ¥æ”¶å¹¶æ‰“ä¸Šæ—¶é—´æˆ³ã€‚
2. æ•°æ®é€šè¿‡æ¥æ”¶æµæ¥å£è¿›å…¥`mqnic_core`ï¼Œè¿›è¡ŒäºŒå±‚å…¥ç¯å¤„ç†`mqnic_l2_ingress`ã€‚
3. æ•°æ®è¢«å‘ˆç°ç»™åº”ç”¨éƒ¨åˆ†`mqnic_app_block`ã€‚äº¤äº’wireä¸º`s_axis_direct_rx`å’Œ`m_axis_direct_rx`ã€‚
4. æ•°æ®è¿›å…¥per-portçš„rxå¼‚æ­¥FIFOæ¨¡å—ï¼Œå¹¶è¢«è½¬ç§»åˆ°æ ¸å¿ƒæ—¶é’ŸåŸŸã€‚
5. æ•°æ®è¢«å‘ˆç°ç»™åº”ç”¨éƒ¨åˆ†`mqnic_app_block` ã€‚äº¤äº’wireä¸º`s_axis_sync_rx`å’Œ`m_axis_sync_rx`ã€‚
6. æ•°æ®è¿›å…¥per-portçš„å¼‚æ­¥FIFOæ¨¡å—ï¼Œå¹¶è¢«èšåˆæˆå•ä¸ªæµã€‚
7. æ•°æ®è¢«å‘ˆç°ç»™åº”ç”¨éƒ¨åˆ†`mqnic_app_block` ã€‚äº¤äº’wireä¸º`s_axis_if_rx`å’Œ`m_axis_if_rx`ã€‚

### 8.3 ingresså’Œrxå¼•æ“å¤„ç†

1. è¿›è¡Œå…¥ç¯å¤„ç†`mqnic_ingress`ã€‚
2. è®¡ç®—æ•°æ®åŒ…æµå“ˆå¸Œ`rx_hash`å’Œæ•°æ®åŒ…æœ‰æ•ˆè½½è·æ ¡éªŒå’Œ`rx_checksum`ã€‚
3. ç”Ÿæˆæ¥æ”¶è¯·æ±‚ç»™`mqnic_interface_rx`ã€‚
4. æ¥æ”¶è¯·æ±‚åˆ°è¾¾æ¥æ”¶å¼•æ“`rx_engine`ã€‚
5. æ¥æ”¶å¼•æ“é€šè¿‡`m_axis_rx_desc_*`å‘å‡ºå†™è¯·æ±‚åˆ°æ¥å£DMAå¼•æ“`rx_engine` ã€‚
6. æ¥å£DMAæ¨¡å—`mqnic_interface_rx`å°†æ•°æ®åŒ…æ•°æ®ä»AXIæµå†™å…¥æ¥å£æœ¬åœ°DMA RAMã€‚é€šè¿‡`rx_axis_*`ã€‚
7. æ¥æ”¶å¼•æ“`rx_engine`å‘å‡ºæè¿°ç¬¦è¯·æ±‚`m_axis_desc_req_*`ã€‚

### 8.4 æè¿°ç¬¦è·å–æ¨¡å—

1. æè¿°ç¬¦è·å–æ¨¡å—`desc_fetch`å‘å‡ºå‡ºé˜Ÿè¯·æ±‚åˆ°é˜Ÿåˆ—ç®¡ç†å™¨ã€‚é€šè¿‡`m_axis_desc_dequeue_req_*`ã€‚
2. é˜Ÿåˆ—ç®¡ç†å™¨`queue_manager`å¤„ç†å‡ºé˜Ÿè¯·æ±‚å¹¶è¿”å›æ“ä½œçŠ¶æ€å’ŒDMAåœ°å€`s_axis_dequeue_resp_*`ã€‚
3. æè¿°ç¬¦è·å–æ¨¡å—æŠ¥å‘Šæè¿°ç¬¦è·å–çŠ¶æ€å¹¶é€šè¿‡`m_axis_dma_read_desc_*`å‘å‡ºDMAè¯»è¯·æ±‚ã€‚
4. DMAè¯»æ¥å£å‘å‡ºPCIeè¯»è¯·æ±‚`dma_if_pcie_us_rd`å¹¶å†™å…¥desc fetchæœ¬åœ°DMA RAMã€‚(é€šè¿‡`s_axis_read_desc_*`)
5. DMAè¯»æ¥å£å‘å‡ºçŠ¶æ€æ¶ˆæ¯`dma_if_pcie_us_rd m_axis_read_desc_status_*`ã€‚
6. æè¿°ç¬¦è·å–æ¨¡å—å‘å‡ºå‡ºé˜Ÿæäº¤æ¶ˆæ¯`desc_fetch m_axis_desc_dequeue_commit_*`ã€‚
7. é˜Ÿåˆ—ç®¡ç†å™¨æäº¤å‡ºé˜Ÿæ“ä½œå¹¶æ›´æ–°æ¶ˆè´¹è€…æŒ‡é’ˆ`queue_manager`ã€‚

### **8.5 Linuxå†…æ ¸å¤„ç†**:

1. Linuxå†…æ ¸è°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åº`mqnic_irq_handler()`ã€‚
2. å¤„ç†äº‹ä»¶é˜Ÿåˆ—å¹¶è°ƒç”¨é€‚å½“çš„å¤„ç†ç¨‹åº`mqnic_process_eq()`ã€‚
3. å¯ç”¨NAPIè½®è¯¢`mqnic_rx_irq()`ã€‚
4. Linuxå†…æ ¸è°ƒç”¨`mqnic_poll_rx_cq()`ã€‚
5. å¤„ç†å®Œæˆé˜Ÿåˆ—`mqnic_process_rx_cq()`ã€‚
6. è¯»å–CQç”Ÿäº§è€…æŒ‡é’ˆï¼Œè¯»å–å®Œæˆè®°å½•ï¼Œè·å–æ–°çš„`sk_buff`ï¼Œè®¾ç½®ç¡¬ä»¶æ—¶é—´æˆ³ï¼Œå–æ¶ˆæ˜ å°„é¡µé¢ï¼Œå…³è”é¡µé¢ä¸`sk_buff`ï¼Œè®¾ç½®`sk_buff`é•¿åº¦ï¼Œå¹¶å°†`sk_buff`äº¤ç»™`napi_gro_frags()`ã€‚
7. å‡ºé˜Ÿå®Œæˆè®°å½•ï¼Œæ›´æ–°CQæ¶ˆè´¹è€…æŒ‡é’ˆï¼Œæ›´æ–°ç¯æ¶ˆè´¹è€…æŒ‡é’ˆï¼Œè°ƒç”¨`mqnic_refill_rx_buffers()`ã€‚
8. ç¦ç”¨NAPIè½®è¯¢`mqnic_poll_rx_cq()`ã€‚
9. rearm CQ`mqnic_arm_cq()`ã€‚

## 9. åŸå§‹corundumå„æ–¹é¢æ€§èƒ½è®°å½•

## 10. 100G-MQNICç§»æ¤U200è¿‡ç¨‹è®°å½•

å‚è€ƒ[Contents â€” Corundum documentation](https://docs.corundum.io/en/latest/contents.html)ç¬¬äºŒç« Get-Startedï¼Œä½†æ˜¯æœ‰å¾ˆå¤šæœªå®Œå–„çš„éƒ¨åˆ†ã€‚

### æœ¬äººé…ç½®

<aside>
ğŸ’¡

Ubuntu 22.04.05 LTS-Desktopç‰ˆ

å†…æ ¸ä¸ºLinux 6.5.0-45-generic

Vivado2020.2 HLx

python 3.10

gcc-11

</aside>

Ubuntu 22.04.05 LTS-Desktopç‰ˆ

å†…æ ¸ä¸ºLinux 6.5.0-45-generic

Vivado2020.2 HLx

python 3.10

gcc-11

### è¸©è¿‡çš„å‘

**1. ç³»ç»Ÿæ–¹é¢ï¼š**

ä¸èƒ½å¤ªæ–°ï¼Œä¹Ÿä¸èƒ½å¤ªè€ã€‚Linux Kernel-6.8åœ¨æœ€æ–°branchä¸­ä¹Ÿæä¾›äº†æ”¯æŒï¼Œcorundumè€ç‰ˆæœ¬ä¸æ”¯æŒã€‚å…·ä½“è¡¨ç°ä¸ºç¼–è¯‘é©±åŠ¨ä¼šæŠ¥å¾ˆå¤šé”™ã€‚

**2.Vivadoç¯å¢ƒï¼š**

æœ€å¥½ä½¿ç”¨Vivado2020.2ï¼Œå…¶ä»–ç‰ˆæœ¬è§è®ºå›ä¸­å¤šå°‘æœ‰äº›é”™è¯¯ã€‚

**3.Licenseï¼š**

100G-NICåªéœ€è¦CMAC-IPçš„è¯ä¹¦ï¼Œå…¶ä½™ç‰ˆæœ¬å‡ä¸éœ€è¦ä»»ä½•Licenseã€‚

**4.makeå·¥ç¨‹æ‰“å¼€GUIå‘ç°è®¸å¤šwarningï¼š**

æ— é¡»æ›´æ”¹ï¼ŒåŸå·¥ç¨‹ç¦ç”¨äº†ddr4ï¼ˆDDR4_ENABLE=0ï¼‰ï¼Œæ‰€ä»¥ä¼šå‡ºç°ddr4-ipå‰æœ‰çº¢è‰²é—®å·ã€‚gty-ipä¸‹æœ‰å¤šä¸ªç±»ä¼¼æƒ…å†µï¼Œæ— é¡»ä¿®å¤ã€‚

**5.ç¼–è¯‘å™¨ï¼š**

ä½¿ç”¨gcc-11

**6.ä»¿çœŸç¯å¢ƒcocotbæ­å»ºï¼š**

corundumçš„ä»¿çœŸä½¿ç”¨çš„æ˜¯cocotbï¼Œéœ€è¦python3.10ï¼Œå…¶ä½™å¤šä¸ªç‰ˆæœ¬ä¼šå‡ºé”™ï¼Œç›¸å…³åŒ…ä¾èµ–å®‰è£…ä½¿ç”¨tox.iniä¸­çš„ç‰ˆæœ¬å·ã€‚

**7.é©±åŠ¨å†…æ ¸ç­¾åé—®é¢˜ï¼š**

1. ç¡®ä¿å®‰å…¨bootå¤„äºdisableçŠ¶æ€ï¼Œè¯¦è§[https://askubuntu.com/questions/773734/how-to-install-module-ko-module-without-kernel-signature-or-kernel-rebuild-in-ub](https://askubuntu.com/questions/773734/how-to-install-module-ko-module-without-kernel-signature-or-kernel-rebuild-in-ub)
2. cd /path/to/corundum/modules/mqnic
3. vi Makefileå¹¶ä¸”åœ¨"KDIR ?= /lib/modules/$(shell uname -r)/build"åæ·»åŠ 

```bash
CONFIG_MODULE_SIG=n
```

1. é‡æ–°makeå¹¶ä¸”insmod

 ä¹‹åinsmodé©±åŠ¨dmesgä»ç„¶ä¼šæŠ¥**æ— ç­¾å**ï¼Œä½†æ˜¯å®é™…ä¸Šè£…ä¸Šå»äº†ã€‚

**8.çƒ§å½•bitstreamï¼š**

çƒ§å½•bitstreamæœ‰å¤šç§æ–¹å¼ï¼Œæœ€ç®€å•ä¹Ÿæœ€æ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨Vivado GUIçš„hardware managerã€‚ä½†æ˜¯æ­¤ç§æ–¹å¼çƒ§å½•åï¼Œ**éœ€è¦æ³¨æ„çš„æ˜¯çƒ§å½•è¿›çš„æ˜¯FPGAçš„æ˜“å¤±æ€§å­˜å‚¨å™¨ï¼ŒFPGAä¸å¯ä»¥æ‰ç”µï¼Œå¦åˆ™éœ€è¦é‡æ–°çƒ§å½•ã€‚**

**9.å¦‚ä½•ä½¿è®¾è®¡ç”Ÿæ•ˆï¼š**

çƒ§å½•è¿›bitstreamåæœ€å…³é”®çš„ä¸€æ­¥æ˜¯ä½¿å¾—Linuxçš„PCIeé‡æ–°scanè®¾å¤‡ã€‚æœ‰å¤šç§æ–¹å¼ï¼š

1. å¦‚æœæ¿å¡ç‹¬ç«‹ä¾›ç”µï¼Œåˆ™ç›´æ¥ç¡¬é‡å¯ä¸»æœºå³å¯ã€‚
2. å¦‚æœæ¿å¡ç”±ä¸»æœºä¾›ç”µï¼Œä¸”corundumè®¾è®¡å›ºåŒ–åœ¨éæ˜“å¤±æ€§å­˜å‚¨å™¨ä¸­ï¼ˆç”±mqnic-fwï¼Œæˆ–è€…PCIeé‡‘æ‰‹æŒ‡çƒ§å½•ï¼‰ï¼Œå¯ä»¥ç›´æ¥é‡å¯ä¸»æœºã€‚
3. å¦‚æœæ¿å¡ç”±ä¸»æœºä¾›ç”µï¼Œä¸”åªæ˜¯ä½¿ç”¨Vivadoçƒ§å½•å·¥å…·ç»ç”±JTAGçƒ§å½•ï¼Œåˆ™æ¯”è¾ƒéº»çƒ¦ï¼š

```bash
cd /path/to/corundum/scripts/pcie
sudo ./pcie_reset.sh 41:00.0  #é‡ç½®PCIeæ’æ§½
sudo rmmod mqnic  #å¸è½½é©±åŠ¨
sudo ./pcie_rescan.sh #æ‰«æPCIeè®¾å¤‡
cd /path/to/corundum/modules/mqnic
sudo insmod mqnic.ko  #é‡æ–°è£…è½½é©±åŠ¨
```

10.è®¾ç½®ip

```bash
ip a #æŸ¥çœ‹ç½‘å£åï¼Œä¸ºenp65s0np0
sudo ip link set dev enp65s0np0 up
sudo ip addr add 172.0.0.2/24 enp65s0np0
sudo ip link set mtu 9000 dev enp65s0np0
ping 10.0.0.2 #èƒ½pingé€š
```
